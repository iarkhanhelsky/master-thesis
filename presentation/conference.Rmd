
---
title: "Алгоритмы обработки временных рядов на основе вейвлетов Хаара"
author: "Архангельский Илья Андреевич"
output:
  beamer_presentation:
    includes:
      in_header: ../src/style/header_beamer.tex
    incremental: yes
    keep_tex: yes
    toc: yes
  ioslides_presentation:
    incremental: yes
  slidy_presentation:
    incremental: yes
---
```{r, echo=FALSE, message=FALSE}
source('../src/r/helpers/visual.r')
source('../src/r/statistics.r')
```
## План 

- Введение
- Вейвлет Хаара. Принцип построения
- Дискретное вейвлет преобразование и его асимптотические свойства
- Пример. Точечное изменение отсчетов авторегрессионного ряда
- Задача о разладке бинарной последовательности
- Критерии определения разладки
- Эмпирические оценки ошибок первого и второго рода

## Ввведение

Преобразование Фурье является достаточно популярным и хорошо изученным инструментом в сфере обработки сигналов и анализа временных рядов. Однако:

- из анализируемого сигнала $x(t)$ невозможно напрямую получить информацию описывающую его частотную характеристику
- хотя разложение $X(f)$ полученное с помощью преобразовнаия Фурье сингнала $x(t)$ содержит в себе всю информацию о сигнале в частотном пространстве, нет ни какой информации о том где конкретно во времени та или иная частота появилась. Иными словами ни $x(t)$, ни $X(f)$ не дают полного описания сигнала.

Альтернативой не обладающей такими недостатками является вейвлет-преобразование.

## Вейвлет Хаара

Любая локализованная $\mathbb{R}$-функция $\psi \in L_2(\mathbb{R})$, где $L_2([a,b])$ - множество интегрируемых в квадратах функций, называется **$\mathbb{R}$-вейвлетом** (или просто вейвлетом), если для нее существует функция $\overset{*}{\psi} \in L_2(\mathbb{R})$ такая, что семейства $\lbrace\psi_{jk}\rbrace$ и $\lbrace\overset{*}{\psi_{jk}}\rbrace$, построенные как

$$
\psi_{jk}(t) = 2^{j/2}\psi(2^jt-k), ~~ j,k \in \mathbb{Z}
$$

и

$$
 \psi^{jk}(t) = \overset{*}{\psi_{jk}}(t) = 2^{j/2}\overset{*}{\psi}(2^jt-k)
$$

являются парными базисами функционального пространства $L_2(\mathbb{R})$

----

### Принцип построения вейвлета Хаара

Пусть имеем некоторый сигнал $x(t)$, он может быть аппроксимирован взвешенной суммой \textit{импульсных} функций единичтной нормы:
    $$
        x(t) = \sum_i s_i \phi_{[t_j, t_j+1[}~,
    $$
где $\phi_{[t_j, t_{j+1}[}$ функция с окном $t_{j+1} - t_j$ :
    $$
       \phi_{[t_j, t_{j+1}[} =
        \begin{cases}
            1, t \in [t_j, t_{j+1}[ \\
            0, t \not\in [t_j, t_{j+1}[
        \end{cases}
    $$
    
----

Возьмем две таке импульсные функции
    $$
        \phi_{[0, 1/2[} =
            \begin{cases}
                1, t \in [0, 1/2[ \\
                0, t \not\in [0, 1/2[
            \end{cases}
        \phi_{[1/2, 1[} =
            \begin{cases}
                1, t \in [1/2, 1[ \\
                0, t \not\in [1/2, 1]
            \end{cases}
    $$
    
----

Сумма этих функций дает нам более широкую импульсную функцию
    $$
        \phi_{[0, 1[} =  \phi_{[0, 1/2[} + \phi_{[1/2, 1[} =
            \begin{cases}
                1, t \in [0, 1[ \\
                0, t \not\in [0, 1[
            \end{cases}
    $$
Разность дает нам базовый вейвлет Хаара
$$
    \psi =  \phi_{[0, 1/2[} - \phi_{[1/2, 1[} =
        \begin{cases}
           ~~ 1, t \in [0, 1/2[ \\
            -1, t \in [1/2, 1[
        \end{cases}
$$

----

Примеры графиков вейвлетов Хаара с разными параметрами масштаба и смещения.
```{r, echo=FALSE}
  source('../src/r/wavelets.r')
  library(ggplot2)
  library(reshape2)
  t <- seq(-1, 2, length.out=1000)
  data <- data.frame(
    a = wavelet.haar(t, 0, 0),
    b = wavelet.haar(t, 1, 0),
    c = wavelet.haar(t, -1, 1),
    t = t
  )
  
  data.long <- melt(data, id='t', value.name='psi')
  ggplot(data=data.long,
       aes(x=t, y=psi, colour=variable)) +
       scale_colour_hue(labels=c("j = 0, k = 0", "j = 1, k = 0", "j = -1, k = 1")) +
       facet_wrap(~variable) +
       geom_line()

```

## Дискретное вейвлет преобразование и его асимптотические свойства
Здесь и далее примем следующие предположения:

- **Предположение 1. Стационарность**:  Пусть $X(t), ~ t=\overline{0,T-1}$ -- есть стационарный временной ряд с нулевым средним, и пусть $\gamma(u) = E[X(t)X(t + u)], u \in \mathbb{Z}$ - автоковариационная функция

- **Предположение 2. Конечность** : В условиях предположения стационарности выполняется $\sum_{u=-\infty}^{\infty}[1 + |u|]|\gamma(u)| < \infty$


Также мы предполагаем, что работаем с реализацией временного ряда длинны $T$, такой что $T = 2^M$.

----

Вейвлет спектром временного ряда $X$, в масштабе $j$ и смещении $k$, относительно вейвлета $\psi$ называется функция
$$\eta_{jk}^{(\psi)} = \sum_{u=-\infty}^{\infty}\gamma(u)\Psi_{jk}(u), ~ j,k \in \mathbb{Z} $$

, где $\Psi_{jk}$ называется __вейвлет автоковариационной функцией__ и определяется как

$$ \Psi_{jk}(u) = \sum_{t=0}^{\infty}\psi_{jk}(t)\psi_{jk}(t + |u|)   $$

----

Дискретным вейвлет преобразованием для переменных $j = 0, 1,\dots, M; ~ k = 0, 1, \dots T$ назовем функцию

$$ d_{jk}^{\psi}(X) = \sum_{t=0}^{T-1}X(t)  \psi_{jk}(t) $$

что в случае вейвлета Хаара эквивалентно

$$
  d_{jk}(X) = 2^{-\frac{j}{2}}(\sum_{t = 2^j k}^{2^j (k + \frac{1}{2}) - 1} x_t - \sum_{t = 2^j (k+ \frac{1}{2} )}^{2^j (k + 1) - 1} x_t)
$$


----

В указаных выше условиях легко показать, что математическое ожидание ряда, полученного в результате
вейвлет преобразования равно 0:

\begin{align}
E[d_{jk}^{\psi}(X)] = \\
E[\sum_{t=0}^{T-1}X(t)  \psi_{jk}(t)] = \\ 
\sum_{t=0}^{T-1}E[X(t)\psi_{jk}(t)] = \\
\sum_{t=0}^{T-1}E[X(t)]E[\psi_{jk}(t)] = 0
\end{align}


----

Также можно показать, что
$$
Var(d_{jk}^{(\psi)}) \xrightarrow{T \rightarrow \infty} \eta_{jk}^{(\psi)}
$$

Далее используя предельную теорему получаем, что коэффициенты вейвлет преобразования временного ряда, при условии, что соблюдены предположения, по распределению сходится к $\mathcal{N}(0, \eta_{jk}^{(\psi)})$

$$
 d_{jk} \xrightarrow{\mathcal{D}} \mathcal{N}(0, \eta_{jk}^{(\psi)})
$$

## Пример: Точечное изменение отсчетов авторегрессионного ряда.

```{r, echo=FALSE}
alpha <- 0.8
sd <- 1
source('../src/r/model.data.r')
```

Пусть $X$ -- реализация авторегресионного ряда порядка 1, с параметром $\alpha = `r 0.8`$ и дисперсией ошибки $\sigma^2 = `r sd`$, длинны $T = 64$. Пусть, также, $Y$ -- преобразованный ряд $X$, такой что: 
$$ 
  Y(t) = \begin{cases}
    X(t), ~ t \neq 28 \\
    -X(t), ~ t = 28
  \end{cases}
$$

```{r, echo=FALSE}
X <- ar.1(64, 0.8, sd)
Y <- X 
Y[28] = -X[28]
```

----

```{r, echo=FALSE, fig.cap='Авторегресионный ряд порядка 1'}
  len <- length(X)
  data <- rbind(
      data.frame(t=(1:len) - 1, AR=X),
      data.frame(t=(1:len) - 1, AR=Y)      
    )
  data$Series <- rep(
    c(
      "X",
      "Y"     
      ),
    c(len, len))

  ggplot(data,aes(t, AR, colour=Series, linetype=Series)) + 
    geom_line() 
```

----

```{r, echo=FALSE, prompt=FALSE, warning=FALSE, message=FALSE}

visual.multiplot(plot.j(X, Y, 0), plot.j(X, Y, 1), plot.j(X, Y, 2), plot.j(X, Y, 3), plot.j(X, Y, 4), plot.j(X, Y, 5), cols=2)
```

## Задача о разладке бинарной последовательности

Пусть $X$ -- последовательность бит фиксированной длинны $2^T$. 
При этом, предполагаем, что: 

$$
  X(t) = \begin{cases}
    X_1(t), \forall t = \overline{0, 2^{\tau} - 1} \\
    X_2(t), \forall t = \overline{2^{\tau}, 2^T}
  \end{cases}
$$

Причем, $X_1(\cdot)$ и $X_2(\cdot)$ такие, что 

\begin{align}
  P(X_1(t) = 1) = p_1 \forall t \\
  P(X_2(t) = 1) = p_2 \forall t
\end{align}


----

Исходя из сформулированной выше модели можем получить нулевую и альтернативную гипотезу. 


\begin{align}
  H_0: p_1 = p_2 \\
  H_1: p_1 \neq p_2
\end{align}



Иными словами наша задача определить имеет ли последовательность $X(\cdot)$ разладку. И определить момент $t_0$ в который эта разладка произошла.

----
```{r, echo=FALSE}
generator.Bernoulli <- function(p) {
  return (function(n){    
    return (rbinom(n, 1, p))
  })
}


X <- generator.Bernoulli(0.5)(64)
Y <- c(X[1:32], generator.Bernoulli(0.3)(32))
```
Для выполнения приведенных ранее предположений преобразуем данные последовательности следующим образом:

\begin{align}
  \hat{X} = 2 * X - 1 \\
  \hat{Y} = 2 * Y - 1 
\end{align}


----

```{r, echo=FALSE}
X <- 2*X - 1
Y <- 2*Y - 1
```

Применим к ним ДВП.
```{r, echo=FALSE}
visual.multiplot(plot.j(X, Y, 0), plot.j(X, Y, 1), plot.j(X,Y, 2), plot.j(X,Y, 3), plot.j(X,Y, 4), plot.j(X, Y, 5), cols=2)
```

Как мы видим вейвлет преобразование чувствительно к смене параметров распределения. 

# Критерии оценки разладки 

## Критерий, основанный на макимуме вейвлет-периодограммы
Cформулируем критерий определения существования разладки основанный на максимуме периодограммы.

```{r, fig.cap = 'Bernoulli periodogram', echo=FALSE, fig.height=2}
  source('../src/r/statistics.r')
  len <- length(X)
  j <- 1:log2(len) - 1
  len <- log2(len)
  
  px <- sapply(j, function(j) P.j(X, j))
  py <- sapply(j, function(j) P.j(Y, j))

  data <- rbind(
      data.frame(t=(1:len) - 1, x=px),
      data.frame(t=(1:len) - 1, x=py)      
    )

  data$Name <- rep(
    c(
      "X",
      "Y"     
      ),
    c(len, len))

  ggplot(data,aes(t,x, colour=Name)) + 
    geom_point() 
 
```

----

Для каждого уровня разрешения определим периодограмму последовательности, для этого возьмем квадраты полученных коэффициентов вейвлет преобразования
$$
  I_{jk}(X) = d_{jk}(X)^2
$$

Как было показано ранее 

$$
  d_{jk} \xrightarrow{\mathcal{D}} \mathcal{N}(0, \eta_{jk}^{(\psi)})
$$

а следовательно
$$
  I_{jk} \xrightarrow{\mathcal{D}} \chi^2_1
$$

---- 

Определим максимум вейвлет-периодограмм на каждом уровне разрешения $j$:
$$
  I_j = \max_{k = \overline{0, m}} I_{jk}(X), ~ m = 2^{T - (j+1)}
$$
Легко показать, что если $F_{I_j}(x)$ -- функция распределения вероятностей статистики $I_j$, а $F_{\chi^2_1} (x)$ -- функция распределения хи-квадрат с одной степенью свободы, то 
$$
  (F_{I_j}(x) - F_{\chi^2_1} (x)) \xrightarrow{\mathcal{D}} 0, ~ x \geq 0
$$

Тогда статисткиой $P_j(\cdot)$ для уровня $j$, назовем статистику вида

$$
  P_j(X) = 1 - F_{\chi^2}(I_j(X))^{T - j}
$$

, где $F_{\chi^2}$ -- функция распределения $\chi^2$


----

Говорим, что принимаем гипотезу $H_0$, если
$$
  P_j(X) > \varepsilon, \forall j = \overline{1,T-1}
$$
, где $\varepsilon = \frac{\varepsilon^0}{T}$,
иначе принимаем $H_1$.

## Критерий, основанный на скейлограмме.

Определим скейлограмму $S^{(\psi)}(j)$

$$
  S^{(\psi)}(j) = \sum_{k=0}^{2^{M-j}-1}[d_{jk}]^2, ~ j = \overline{1,M}
$$

Тогда аналогично предыдущему пункту получаем, что если 
$$
  d_{jk} \xrightarrow{\mathcal{D}} \mathcal{N}(0, \eta_{jk}^{(\psi)})
$$

то скейлограмма $S^{(\psi)}(j)$ имеет хи-квадрат распределение с числом степеней свободы $L=2^{M-j}$, как сумма квадратов независимых стандартных гауссовских величин. 


----

Критерий для обнаружения разладки последовательности, основанный на скейлограмме, аналогичен по построению, критерию, основанному на максимуме вейвлет-периодограммы, при этом $P$-значение для каждого уровня разрешения определяется как 
$$
  P_j = 1 - F_{\chi,L}(S^{\psi}(j))
$$

## Анализ эффективности критерие методом статистического моделирования

Число моделируемых последовательностей для оценки вероятностей ошибок первого и второго рода расмотренных критериев $K = 1000$. Проверка гипотез $H_0$ и $H_1$, проводилаь на уровнях разрешения ($j > M -3$).

Для оценки вероятностей ошибок первого рода моделировались бинарные последовательности длинной $T$, равной $2^8$, $2^{10}$ и $2^{12}$, с вероятностью $p = 0.5$. Уровень значимости для проверки нулевой гипотезы  $H_0$ задавался равным $\alpha=0.05$

----

Для оценки вероятностей ошибок второго рода моделируемые последовательности состояли из двух однородных фрагментов длинной $T_1 = T_2 = T/2$ с разладкой в момент времени $\tau$, соотвественно равной $2^7$,$2^9$,$2^{11}$. Первый фрагмент представлял собой случайную бинарную последовательность с вероятностью $p = 0.5$, а для второго фрагмента вероятность $p$ принимала значения $0.05, 0.1, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45$.

## Оценки ошибок первого и второго рода.
```{r, echo=FALSE, message=FALSE, fig.height=5}

require(ggplot2)
require(reshape2)

K <- 1000
q <- seq(0.05, 0.45, 0.05)
data.false.negative <- lapply(rep(sample(c(8, 10, 12)), length.out=K), function(t) rbinom(2**t, 1, 0.5))
data.false.positive <- lapply(rep(sample(c(8, 10, 12)), length.out=K), function(t) {
  c(rbinom(2**(t-1), 1, 0.5), rbinom(2**(t - 1), 1, sample(q)))
})

false.negative.scale <- sapply(data.false.negative, criterium.scalegram)
false.negative.period <- sapply(data.false.negative, criterium.periodogram)

false.positive.scale <- sapply(data.false.positive, criterium.scalegram)
false.positive.period <- sapply(data.false.positive, criterium.periodogram)

errors <- data.frame(
  a = sapply(1:K, function(k) length(which(!false.negative.scale [1:k])) / k), # Ошибка первого рода, считаем все FALSE
  b = sapply(1:K, function(k) length(which(!false.negative.period[1:k])) / k), # Ошибка первого рода, считаем все FALSE
  c = sapply(1:K, function(k) length(which(false.positive.scale  [1:k])) / k), # Ошибка второго рода, считаем все TRUE
  d = sapply(1:K, function(k) length(which(false.positive.period [1:k])) / k), # Ошибка вторго рода, считаем все TRUE
  k = 1:K
)

data.long <- melt(errors, id='k', value.name='error')
ggplot(data=data.long,
       aes(x=k, y=error, colour=variable)) +
  scale_colour_hue(labels =(c("a) False negative Scalegram",
                              "b) False negative Periodogram",
                              "c) False positive Scalegram",
                              "d) False positive Periodogram"))) +
  facet_wrap(~variable) +
  geom_line()
```

## Выводы

- Точность оценки растет с увеличением длинны последовательности
- Указанные критерии могут успешно применятся в различных приложениях
- Точное место может быть с легкостью восстановлено по формуле $\tau = 2^{j_0} + k_0$, где $j_0, ~ k_0$ - уровень детализации и смещение на которых нулевая гипотеза не выполняется соотвественно.

