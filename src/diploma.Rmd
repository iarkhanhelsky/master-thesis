---
title: Анализ разладки последовательности
bibliography: references.bib
csl: style/citations.csl
---
```{r, echo=FALSE}
  require('ggplot2')
```
```{r, echo=FALSE}
 sum.lazy <- function(gen, count){
   c <- 0
   s <- 0
   while(c < count){
     c <- c + 1
     s <- s + gen(1)
   }

   reutrn(s)
 }
```
# Aнализ разладки последовательности
## Введение
В данной главе мы будем оценивать положение точки разладки битовой последовательности, получая оценку как решение следующей задачи. Пусть дана последовательность бит проиндексированная в каждый момент времени $t$, то есть
  $$ x_t \in \{ 0, 1\} ~ \forall t \in \mathbb{N} $$
Предполагаем, что $\exists T$ такое, что
  $$P(x_t = 1) = 1 - P(x_t = 0) = \theta, ~ \forall t < 2^T$$
Иными словами преполагаем, что $x_t, \forall t < 2^T$ есть случанйня бернулевская величина, распределенная по закону $Be(\theta)$. Предположим также, что для __хвоста__ последовательности справедливо
  $$P(x_t = 1) = 1 - P(x_t = 0) = \gamma, ~ \forall t >= 2^T$$
то есть, величины, составляющие хвост последовательности распределены по закону $Be(\gamma)$.
Наша задача, состоит в том, чтобы оценить параметр $T$.

## Вейвлет преобразование

### Вейвлет
Любая локализованная $\mathbb{R}$-функция $\psi \in L_2(\mathbb{R})$, где $L_2([a,b])$ - множество интегрируемых в квадратах функций, называется $\mathbb{R}$-вейвлетом (или просто вейвлетом), если для нее существует функция $\overset{*}{\psi} \in L_2(\mathbb{R})$ такая, что семейства $\lbrace\psi_{jk}\rbrace$ и $\lbrace\overset{*}{\psi_{jk}}\rbrace$, построенные как

$$
\psi_{jk}(t) = 2^{j/2}\psi(2^jt-k), ~~ j,k \in \mathbb{Z}
$$

и

$$
 \psi^{jk}(t) = \overset{*}{\psi_{jk}}(t) = 2^{j/2}\overset{*}{\psi}(2^jt-k)
$$

являются парными базисами функционального пространства $L_2(\mathbb{R})$[@daub].

Каждый таким образом определенный вейвлет $\psi$, независимо от того, ортогональный он или нет, позволяет любую функцию $f \in L_2(\mathbb{R})$ представить в виде ряда
$$
          f(t) = \sum_{j,k = -\infty}^{\infty} c_{jk}\psi_{jk}(t)
$$

коэффициенты которого определяются интегральным вейвлет-преобразованием $f$ относительно $\overset{*}{\psi}$.
Вейвлет-двойник $\overset{*}{\psi}$ -- единственный и сам является $\mathbb{R}$-вейвлетом. Пара $(\psi, \overset{*}{\psi})$ симметрична в том смысле, что $\psi$ в свою очередь является двойником для $\overset{*}{\psi}$.
Если $\mathbb{R}$-вейвлет $\psi$ обладает свойством ортоганальности, то $\overset{*}{\psi} \equiv \psi$, и $\lbrace \overset{*}{\psi_{jk}} \rbrace \equiv \lbrace \psi_{jk} \rbrace$ -- ортогональный базис.

Для многих практических целей достаточно, чтобы вейвлет обладал свойством полуортогональности, т.е. чтобы его базис Рисса $\lbrace \psi_{jk} \rbrace$ удовлетворял условию $\langle \psi_{jk},  \psi_{lm}\rangle = 0$ при $j = l, ~ j,k,l,m \in \mathbb{Z}$.

$\mathbb{R}$-вейвлет называется неортогональным, если он не является полуортогональным вейвлетом. Однако, будучи $\mathbb{R}$-вейвлетом, он имеет двойника, и пара $(\psi, \overset{*}{\psi})$ дает возможность формировать семейства $\lbrace\psi_{jk}\rbrace$ и $\lbrace\overset{*}{\psi_{jk}}\rbrace$, удовлетворяющие условию биортогональности $\langle \psi_{jk}, \overset{*}{\psi_{lm}}\rangle = \delta_{jl}\delta_{km}, ~~ j,k,l,m \in \mathbb{Z}$ и позволяющие построить полноцыенные ряды по вейвлетам и реконструкционную формулу.
С необходимостью иметь обратное вейвлет преобразование (или реконструкционную формулу) связано большинство ограничений, накладываемых на вейвлет.

### Построение вейвлета Хаара
Пусть имеем некоторый сигнал $x(t)$, он может быть аппроксимирован взвешенной суммой \textit{импульсных} функций единичтной нормы:
    $$
        x(t) = \sum_i s_i \phi_{[t_j, t_j+1[}~,
    $$
где $\phi_{[t_j, t_{j+1}[}$ функция с окном $t_{j+1} - t_j$ : \\
    $$
       \phi_{[t_j, t_{j+1}[} =
        \begin{cases}
            1, t \in [t_j, t_{j+1}[ \\
            0, t \not\in [t_j, t_{j+1}[
        \end{cases}
    $$
Возьмем две таке импульсные функции
    $$
        \phi_{[0, 1/2[} =
            \begin{cases}
                1, t \in [0, 1/2[ \\
                0, t \not\in [0, 1/2[
            \end{cases}
        \phi_{[1/2, 1[} =
            \begin{cases}
                1, t \in [1/2, 1[ \\
                0, t \not\in [1/2, 1[
            \end{cases}
    $$
Сумма этих функций дает нам более широкую импульсную функцию
    $$
        \phi_{[0, 1[} =  \phi_{[0, 1/2[} + \phi_{[1/2, 1[} =
            \begin{cases}
                1, t \in [0, 1[ \\
                0, t \not\in [0, 1[
            \end{cases}
    $$
Разность дает нам базовый вейвлет Хаара[@haar]
$$
    \psi =  \phi_{[0, 1/2[} - \phi_{[1/2, 1[} =
        \begin{cases}
           ~~ 1, t \in [0, 1/2[ \\
            -1, t \in [1/2, 1[
        \end{cases}
$$

```{r, echo=FALSE}
  psi <- function(t, j = 0, k = 0)
  {
    psi_base <- function(t)
    {
      ifelse(t > 0 & t < 0.5,
             1,
             ifelse(t >= 0.5 & t < 1, -1, 0)
             );
    };

    (2**(j)) * psi_base(2**j * (t - k));
  }
```
```{r, echo=FALSE, fig.cap='График базового вейвлета Хаара'}
  t <- seq(-0.1, 1.1, 0.001)
  qplot(t, psi(t), geom='line', xlab='t') + ylab(expression(psi))
```


### Обобщение вейвлета Хаара
Применяя подобные операции получаем бесконечное число функций вида
    $$
        \psi_{jk} = 2^{j/2}\psi(2^j (t - k))~,
    $$
которые вместе с $\phi_{]-\infty, \infty[}$ составляют базис в пространстве $L_2(\mathbb{R})$.

Таким образом $x(t)$ может быть представлен в виде:
$$
    x(t) = s_0\phi_{[0, 1/2[} + s_1 \phi_{[1/2, 1[]} = s_0\frac{\phi_{[0, 1[} + \psi_{[0, 1[}}{2} + s_1\frac{\phi_{[0, 1[} - \psi_{[0, 1[}}{2},
$$
где $(s_0 + s_1)/2$ представляет собой среднее функции(общую картину), а $(s_0 - s_1)/2$ представляет изменение функции (детали). Тем самым получено вейвлет-преобразование Хаара функции $x(t)$.

Пусть $\psi$ такое преобразование $t : \mathbb{R} \rightarrow [-1, 1]$, что
  $$
    \psi(t) =
      \begin{cases}
        -1, ~ t \in [0, \frac{1}{2}[ \\
        1, ~t \in[\frac{1}{2}, 1[ \\
        0, ~t \in \mathbb{R} \setminus [0, 1[
      \end{cases}
  $$

Пусть ткаже $\psi_{jk}$ преобразование $t: \mathbb{R} \rightarrow [-2^j, 2^j]$ такое, что
  $$
    \psi_{jk}(t) = 2^{j/2} \psi(2^j (t - k))
  $$


```{r, echo=FALSE, fig.cap='Примеры вейвлетов Хаара с различными параметрами смещения и масштабирования'}
  t <- seq(-5, 5, 0.01)
  qplot(t, binwidth=0.5)
```

## Поиск разладки бинарной последовательности
Вейвлет-преобразование и статистики освнованные на вейвлет-преобразованиях помогают выявить различные закономерности или же, ноборот, отклонения от устоявшихся в данных закономерности. Такую возможность предоставляет разделение входящего сигнала на многие уровни, с различной степенью детализации.

Пусть дана последовательность такая, что первые $2^{\tau}$ бит распределены по закону Бернулли с параметром $\theta1$, а оставшиеся $2^T - 2^{\tau}$ распределены по закону Бернулли с параметром $\theta_2$, или более формально, пусть дана последовательность $X^0 = \{x_i\}_{i=\overline{1,N}}, N = 2^T$, такая что
$$
    \mathcal{L}(x_i) =
    \begin{cases}
      Be(\theta_1) = Bi(\theta_1, 1), ~ i = \overline{1,2^\tau}, \tau < T \\
      Be(\theta_2) = Bi(\theta_2, 1), ~ i = \overline{2^\tau, 2^T}
    \end{cases}
$$

,где $\theta_1, \theta_2 \in [0, 1]$, а $Be(\cdot), Bi(\cdot, \cdot)$ -- распределение Бернулли и биномиальное распределение соотвественно.
Не делая никаких предположений относительно $\theta_1$ и $\theta_2$ за исключением, разве что условия $\theta_1 \neq \theta_2$, оценим параметр $\tau$.
Получим новую последовательность $X$ той же длины, применяя следующее преборазование $X = 2X^0 - 1$ поэлементно к исходной последовательности $X^0$.
Пусть также задано семейство вейвлетов Хаара, определяемое следующим образом:
$$
  \psi_{jk}(t) = 2^{j/2}\psi(2^j (t - k)), ~
  \psi(t) = \begin{cases}
  1, t \in [0, \frac{1}{2}[ \\
  -1, t \in [\frac{1}{2}, 1[ \\
  0, t \not\in [0, 1[
  \end{cases}
$$

Построим следующее вейвлет преобразование $d_{jk}(\cdot)$ :
$$
  d_{jk}(X) = \sum_{t=1}^T \psi(t, j, k)  x_t
$$,
что в нашем случае эквивалентно

$$
  d_{jk}(X) = 2^{-\frac{j}{2}}(\sum_{t = 2^j k}^{2^j (k + \frac{1}{2}) - 1} x_t - \sum_{t = 2^j (k+ \frac{1}{2} )}^{2^j (k + 1) - 1} x_t)
$$

Возьмем квадраты полученных коэффициентов
$$
  I_{jk}(X) = d_{jk}(X)^2
$$

и выберем максимальный из них по $k$:
$$
  I_j = \max_{k = \overline{0, m}} I_{jk}(X), ~ m = 2^{T - (j+1)}
$$

Тогда статисткиой $P_j(\cdot)$ для уровня $j$, назовем статистику вида

$$
  P_j(X) = 1 - F_{\chi^2}(I_j(X))^{T - j}
$$

, где $F_{\chi^2}$ -- функция распределения $\chi^2$

Говорим, что принимаем гипотезу $H_0$, если
$$
  P_j(X) > \varepsilon, \forall j = \overline{1,T-1}
$$
, где $\varepsilon = \frac{\varepsilon^0}{T}$,
иначе принимаем $H_1$.

```{r, echo=FALSE}
d <- function(X, j, k)
{
  t <- 2**(-j/2) * (sum(X[(2**j * k) : (2**j * (k + 1/2) - 1)]) - sum(X[(2**j * (k + 1/2)) : (2**j * (k+1) - 1)]))
  return(t)
}
```

```{r, echo=FALSE}
  I_jk <- function(X, j, k){d(X, j, k) ** 2}
```

```{r, echo=FALSE}
  I_j <- function(X, j){ max(sapply(c(0:((2^log2(length(X))) / 2^(j+1) )), FUN=function(k){I_jk(X, j, k)}))}
```

```{r, echo=FALSE}
  F_hi2 <- function(t){ t**(-1/2) * exp(-t/2) / sqrt(2*pi) }
```

```{r, echo=FALSE}
  P_j <- function(X, j){1 - (dchisq(I_j(X, j), 1) ** (log2(length(X)) - j))}
```

\appendix
\chapter{Приложение}

## Генерация последовательности(модельных данных)

Для генерации последовательности определим несколько вспомогательных функций:

 * Функция, которая порождает генератор бернулевской последовательности с заданным параметром p
```{r}
  generator.Bernoulli <- function(p) {
    return (function(n){
      return (rbinom(n, 1, p))
    })
  }
```

 * Функция, которая объеденит два генератора, при этом, первые $n$ значений будут получены из первого генератора, а последующие значения будут получены из второго генератора.
```{r}
  generator.njoin <- function(first, second, n){
    generated <- 0
    generator.single <- function(){
      generated <- generated + 1
      return (ifelse(generated <= n, first(1), second(1)))
    }

    return (function(n){
      return (replicate(n, generator.single()))
    })
  }
```

Из двух описанных выше функций, несложно получить генератор порождающий исходные данные для нашей задачи

```{r}
  generator.sequence <- function(theta, gamma, T){
    return (generator.njoin(
      generator.Bernoulli(theta),
      generator.Bernoulli(gamma),
      2**T))
  }
```
```{r, echo=FALSE}
  theta = 0.3
  gamma = 0.5
```
Для иллюстрации, построим пробную последовательность, длинны $2^(T + 1)$, где $T = 8$, пологая $\theta=`r theta`, ~ \gamma = `r gamma`$:
```{r, echo=FALSE}
  rsequence <- generator.sequence(0.3, 0.5, 8)
  values <- rsequence(2^(8+1))
```

Построим гистограммы по полученным даннымм

```{r, echo=FALSE}
  qplot(values[1:length(values)/2], binwidth=1)
```

```{r, echo=FALSE}
  qplot(values[length(values)/2:length(values)], binwidth=1)
```

# Ссылки
