# Анализ изменения параметров распределения основанный на вейвлет статистиках

В данной главе мы будем оценивать положение точки разладки битовой последовательности, получая оценку как решение следующей задачи. Пусть дана последовательность бит проиндексированная в каждый момент времени $t$, то есть
  $$ x_t \in \{ 0, 1\} ~ \forall t \in \mathbb{N} $$
Предполагаем, что $\exists T$ такое, что
  $$P(x_t = 1) = 1 - P(x_t = 0) = \theta, ~ \forall t < 2^T$$
Иными словами преполагаем, что $x_t, \forall t < 2^T$ есть случанйня бернулевская величина, распределенная по закону $Be(\theta)$. Предположим также, что для __хвоста__ последовательности справедливо
  $$P(x_t = 1) = 1 - P(x_t = 0) = \gamma, ~ \forall t >= 2^T$$
то есть, величины, составляющие хвост последовательности распределены по закону $Be(\gamma)$.
Наша задача, состоит в том, чтобы оценить параметр $T$.

## Постановка задаче о поиске разладки бинарной последовательности
Вейвлет-преобразование и статистики освнованные на вейвлет-преобразованиях помогают выявить различные закономерности или же, ноборот, отклонения от устоявшихся в данных закономерности. Такую возможность предоставляет разделение входящего сигнала на многие уровни, с различной степенью детализации.

Пусть дана последовательность такая, что первые $2^{\tau}$ бит распределены по закону Бернулли с параметром $\theta1$, а оставшиеся $2^T - 2^{\tau}$ распределены по закону Бернулли с параметром $\theta_2$, или более формально, пусть дана последовательность $X^0 = \{x_i\}_{i=\overline{1,N}}, N = 2^T$, такая что
$$
    \mathcal{L}(x_i) =
    \begin{cases}
      Be(\theta_1) = Bi(\theta_1, 1), ~ i = \overline{1,2^\tau}, \tau < T \\
      Be(\theta_2) = Bi(\theta_2, 1), ~ i = \overline{2^\tau, 2^T}
    \end{cases}
$$

,где $\theta_1, \theta_2 \in [0, 1]$, а $Be(\cdot), Bi(\cdot, \cdot)$ -- распределение Бернулли и биномиальное распределение соотвественно.
Не делая никаких предположений относительно $\theta_1$ и $\theta_2$ за исключением, разве что условия $\theta_1 \neq \theta_2$, оценим параметр $\tau$.
## Дискретное вейвлет преобразование и его асимптотические свойства
Здесь и далее примем следующие предположения:
\Assumption{
\label{ass:stationary}
Пусть $X(t), ~ t=\overline{0,T-1}$ -- есть стационарный временной ряд с нулевым
средним, и пусть $\gamma(u) = E[X(t)X(t + u)], u \in \mathbb{Z} $ - автоковариационная функция
}

\Assumption{\label{ass:finite}
В условиях предположения \ref{ass:stationary} выполняется
 $$ \sum_{u=-\infty}^{\infty}[1 + |u|]|\gamma(u)| < \infty $$ 
}
Также мы предполагаем, что работаем с реализацией временного ряда длинны $T$, такой что $T = 2^M$.

Исходя из того, что выполняются предположения \ref{ass:stationary} и \ref{ass:finite} вейвлет спектром временного ряда $X$, в масштабе $j$ и смещении $k$, относительно вейвлета $\psi$ называется функция
\begin{equation}
  \label{eq:wspectrum}
  \eta_{jk}^{(\psi)} = \sum_{u=-\infty}^{\infty}\gamma(u)\Psi_{jk}(u), ~ j,k \in \mathbb{Z}
\end{equation}
, где $\Psi_{jk}$ называется __вейвлет автоковариационной функцией__ и определяется как
\begin{equation}
  \Psi_{jk}(u) = \sum_{t=0}^{\infty}\psi_{jk}(t)\psi_{jk}(t + |u|)  
\end{equation}
Дискретным вейвлет преобразованием для переменных $j = 0, 1,\dots, M; ~ k = 0, 1, \dots T$ назовем функцию
$$
d_{jk}^{\psi}(X) = \sum_{t=0}^{T-1}X(t)  \psi_{jk}(t)
$$
В указаных выше условиях легко показать, что математическое ожидание ряда, полученного в результате
вейвлет преобразования равно 0:
\begin{align}
E[d_{jk}^{\psi}(X)] = \\
E[\sum_{t=0}^{T-1}X(t)  \psi_{jk}(t)] = \\ 
\sum_{t=0}^{T-1}E[X(t)\psi_{jk}(t)] = \\
\sum_{t=0}^{T-1}E[X(t)]E[\psi_{jk}(t)] = 0
\end{align}

и также можно показать, что 
\begin{align}
 var(d_{jk}^{\psi}(X)) = \sum_{t=0}^{T-1}\sum_{s=0}^{T-1}\gamma(t-s)\psi_{jk}(t)\psi_{jk}(s) = \\
 \sum_{u=-(T-1)}^{T-1}\gamma(u)\sum_{t=0}^{T-1-|u|}\psi_{jk}(t)\psi_{jk}(t + |u|)
\end{align}

Изходя из показанного выше, и при условии, что соблюдается предположение \ref{ass:finite}

$$
 Var(d_{jk}^(\psi)) \xrightarrow{T \rightarrow \infty} \eta_{jk}^{(\psi)}
$$
Далее используя приведенную в [@morettin]  предельную теорему получаем, что вейвлет преобразование
временного ряда, при условии, что соблюдены предположения \ref{ass:stationary}, \ref{ass:finite}, по распределению сходится к $\mathcal{N}(0, \eta_{jk}^{(\psi)})$
$$
 d_{jk} \xrightarrow{\mathcal{D}} \mathcal{N}(0, \eta_{jk}^{(\psi)})
$$

На основании полученных выше заключений расммотрим несколько приложений использования вейвлет-преобразования в анализе временных рядов

\Example{Авторегрессия порядка 1}
```{r, echo=FALSE}
alpha = 0.8
sd = 1
```

Пусть $X$ -- реализация авторегресионного ряда порядка 1[^auto], с параметром $\alpha = `r 0.8`$ и дисперсией ошибки $\sigma^2 = `r sd`$, длинны $T = 64$. Пусть, также, $Y$ -- преобразованный ряд $X$, такой что: 
\begin{equation}
  Y(t) = \begin{cases}
    X(t), ~ t \neq 28 \\
    -X(t), ~ t = 28
  \end{cases}
\end{equation}

```{r, echo=FALSE}
X <- ar.1(64, 0.8, sd)
Y <- X 
Y[28] = -X[28]
```

[^auto]:
  Авторегресионным рядом порядка 1 является временной ряд, каждый последующий отсчет которого определяется по формуле
  $X(t) = \alpha X(t-1) + \xi, ~ \mathcal{L}(xi) = \mathcal{N}(0, \sigma^2)$

```{r, echo=FALSE, fig.cap='Авторегресионный ряд порядка 1'}
  len <- length(X)
  data <- rbind(
      data.frame(psi=(1:len) - 1, k=X),
      data.frame(psi=(1:len) - 1, k=Y)      
    )
  data$Series <- rep(
    c(
      "X",
      "Y"     
      ),
    c(len, len))

  ggplot(data,aes(psi, k, colour=Series, linetype=Series)) + 
    geom_line() 
```

\Example{Последовательности Бернулевских величин}

Пусть $X$ -- последовательность случайных величин Бернулли с параметром $p = 0.5$. А $Y$ - 
последовательность полученная следующим образом:
$$
Y(t) = \begin{cases}
  X(t), t < 2^{\tau} \\
  Be(q), 2^{\tau} \leq t \leq 2^{T} \\
\end{cases}
$$

```{r, echo=FALSE}
generator.Bernoulli <- function(p) {
  return (function(n){    
    return (rbinom(n, 1, p))
  })
}


X <- generator.Bernoulli(0.5)(64)
Y <- c(X[1:32], generator.Bernoulli(0.3)(32))
```

Преобразуем данные последовательности следующим образом:

\begin{align}
  \hat{X} = 2 * X - 1 \\
  \hat{Y} = 2 * Y - 1 
\end{align}

Таким образом получены реализации временных рядов, удовлетворяющие предположениям \ref{ass:stationary}, \ref{ass:finite}.

## Критерии обнаружения разладок бинарных последовательностей.
Здесь мы будем оценивать положение точки разладки битовой последовательности, получая оценку как решение следующей задачи. Пусть дана последовательность бит проиндексированная в каждый момент времени $t$, то есть
  $$ x_t \in \{ 0, 1\} ~ \forall t \in \mathbb{N} $$
Предполагаем, что $\exists T$ такое, что
  $$P(x_t = 1) = 1 - P(x_t = 0) = \theta, ~ \forall t < 2^T$$
Иными словами преполагаем, что $x_t, \forall t < 2^T$ есть случанйня бернулевская величина, распределенная по закону $Be(\theta)$. Предположим также, что для __хвоста__ последовательности справедливо
  $$P(x_t = 1) = 1 - P(x_t = 0) = \gamma, ~ \forall t >= 2^T$$
то есть, величины, составляющие хвост последовательности распределены по закону $Be(\gamma)$.
Наша задача, состоит в том, чтобы оценить параметр $T$, то есть необходимо найти момент разладки.

### Поиск разладки бинарной последовательности
Вейвлет-преобразование и статистики освнованные на вейвлет-преобразованиях помогают выявить различные закономерности или же, ноборот, отклонения от устоявшихся в данных закономерности. Такую возможность предоставляет разделение входящего сигнала на многие уровни, с различной степенью детализации.

Пусть дана последовательность такая, что первые $2^{\tau}$ бит распределены по закону Бернулли с параметром $\theta1$, а оставшиеся $2^T - 2^{\tau}$ распределены по закону Бернулли с параметром $\theta_2$, или более формально, пусть дана последовательность $X^0 = \{x_i\}_{i=\overline{1,N}}, N = 2^T$, такая что
$$
    \mathcal{L}(x_i) =
    \begin{cases}
      Be(\theta_1) = Bi(\theta_1, 1), ~ i = \overline{1,2^\tau}, \tau < T \\
      Be(\theta_2) = Bi(\theta_2, 1), ~ i = \overline{2^\tau, 2^T}
    \end{cases}
$$

,где $\theta_1, \theta_2 \in [0, 1]$, а $Be(\cdot), Bi(\cdot, \cdot)$ -- распределение Бернулли и биномиальное распределение соотвественно.
Не делая никаких предположений относительно $\theta_1$ и $\theta_2$ за исключением, разве что условия $\theta_1 \neq \theta_2$, оценим параметр $\tau$.

Для удобста работы преобразуем исходные данные. Получим новую последовательность $X$ той же длины, применяя следующее преборазование $X = 2X^0 - 1$ поэлементно к исходной последовательности $X^0$.

Построим следующее вейвлет преобразование $d_{jk}(\cdot)$ :
$$
  d_{jk}(X) = \sum_{t=1}^T \psi(t, j, k)  x_t
$$,
что для вейвлета Хаара эквивалентно
\begin{equation}
\label{eq:sep}
  d_{jk}(X) = 2^{-\frac{j}{2}}(\sum_{t = 2^j k}^{2^j (k + \frac{1}{2}) - 1} x_t - \sum_{t = 2^j (k+ \frac{1}{2} )}^{2^j (k + 1) - 1} x_t) 
\end{equation}
Из \ref{eq:sep} следует независимость вейвлет-коэффициентов на каждом уровне разрешения $j$, так как интервалы по которым вычисляются вейвлет коэффициенты не пересекаются. 

#### Критерий, основанный на макимуме вейвлет-периодограммы
Cформулируем критерий определения существования разладки основанный на максимуме периодограммы.

```{r, fig.cap = 'Bernoulli periodogram', echo=FALSE}
  len <- length(X)
  j <- 1:log2(len) - 1
  len <- log2(len)
  
  px <- sapply(j, function(j) P.j(X, j))
  py <- sapply(j, function(j) P.j(Y, j))

  data <- rbind(
      data.frame(t=(1:len) - 1, x=px),
      data.frame(t=(1:len) - 1, x=py)      
    )

  data$Name <- rep(
    c(
      "X",
      "Y"     
      ),
    c(len, len))

  ggplot(data,aes(t,x, colour=Name)) + 
    geom_point() 
 
```

Для каждого уровня разрешения определим периодограмму последовательности, для этого возьмем квадраты полученных коэффициентов вейвлет преобразования
$$
  I_{jk}(X) = d_{jk}(X)^2
$$

Как было показано ранее 

$$
  d_{jk} \xrightarrow{\mathcal{D}} \mathcal{N}(0, \eta_{jk}^{(\psi)})
$$

а следовательно
$$
  I_{jk} \xrightarrow{\mathcal{D}} \chi^2_1
$$

Определим максимум вейвлет-периодограмм на каждом уровне разрешения $j$:
$$
  I_j = \max_{k = \overline{0, m}} I_{jk}(X), ~ m = 2^{T - (j+1)}
$$
Легко показать, что если $F_{I_j}(x)$ -- функция распределения вероятностей статистики $I_j$, а $F_{\chi^2_1} (x)$ -- функция распределения хи-квадрат с одной степенью свободы, то 
$$
  (F_{I_j}(x) - F_{\chi^2_1} (x)) \xrightarrow{\mathcal{D}} 0, ~ x \geq 0
$$

Тогда статисткиой $P_j(\cdot)$ для уровня $j$, назовем статистику вида

$$
  P_j(X) = 1 - F_{\chi^2}(I_j(X))^{T - j}
$$

, где $F_{\chi^2}$ -- функция распределения $\chi^2$

Говорим, что принимаем гипотезу $H_0$, если
$$
  P_j(X) > \varepsilon, \forall j = \overline{1,T-1}
$$
, где $\varepsilon = \frac{\varepsilon^0}{T}$,
иначе принимаем $H_1$.

#### Критерий, основанный на скейлограмме.

Определим скейлограмму $S^{(\psi)}(j)$

$$
  S^{(\psi)}(j) = \sum_{k=0}^{2^{M-j}-1}[d_{jk}]^2, ~ j = \overline{1,M}
$$

Тогда аналогично предыдущему пункту получаем, что если 
$$
  d_{jk} \xrightarrow{\mathcal{D}} \mathcal{N}(0, \eta_{jk}^{(\psi)})
$$

то скейлограмма $S^{(\psi)}(j)$ имеет хи-квадрат распределение с числом степеней свободы $L=2^{M-j}$, как сумма квадратов независимых стандартных гауссовских величин. 

Критерий для обнаружения разладки последовательности, основанный на скейлограмме, аналогичен по построению, критерию, основанному на максимуме вейвлет-периодограммы, при этом $P$-значение для каждого уровня разрешения определяется как 
$$
  P_j = 1 - F_{\chi,L}(S^{\psi}(j))
$$


#### Анализ эффективности критерие методом статистического моделирования
Число моделируемых последовательностей для оценки вероятностей ошибок первого и второго рода расмотренных критериев $K = `r globals$discorded.test.count`$. Проверка гипотез $H_0$ и $H_1$, проводилаь на уровнях разрешения ($j > M -3$).

Для оценки вероятностей ошибок первого рода моделировались бинарные последовательности длинной $T$, равной $2^8$, $2^10$ и $2^12$, с вероятностью $p1 = 0.5$. Уровень значимости для проверки нулевой гипотезы  $H_0$ задавался равным $\alpha=0.05$

Для оценки вероятностей ошибок второго рода моделируемые последовательности состояли из двух однородных фрагментов длинной $T_1 = T_2 = T/2$ с разладкой в момент времени $\tau$, соотвественно равной $2^7$,$2^9$,$2^11$. Первый фрагмент представлял собой случайную бинарную последовательность с вероятностью $p = 0.5$, а для второго фрагмента вероятность $p$ принимала значения $0.05, 0.1, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45$.

```{r, echo=FALSE, warning=FALSE, fig.cap='Эмпирические значения вероятностей ошибок первого и второго рода', dpi=128, dev='png'}

K <-  globals$discorded.test.count
q <- seq(0.05, 0.45, 0.05)
data.false.negative <- lapply(rep(sample(c(8, 10, 12)), length.out=K), function(t) rbinom(2**t, 1, 0.5))
data.false.positive <- lapply(rep(sample(c(8, 10, 12)), length.out=K), function(t) {
  c(rbinom(2**(t-1), 1, 0.5), rbinom(2**(t - 1), 1, sample(q)))
})

false.negative.scale <- sapply(data.false.negative, criterium.scalegram)
false.negative.period <- sapply(data.false.negative, criterium.periodogram)

false.positive.scale <- sapply(data.false.positive, criterium.scalegram)
false.positive.period <- sapply(data.false.positive, criterium.periodogram)

errors <- data.frame(
  a = sapply(1:K, function(k) length(which(!false.negative.scale [1:k])) / k), # Ошибка первого рода, считаем все FALSE
  b = sapply(1:K, function(k) length(which(!false.negative.period[1:k])) / k), # Ошибка первого рода, считаем все FALSE
  c = sapply(1:K, function(k) length(which(false.positive.scale  [1:k])) / k), # Ошибка второго рода, считаем все TRUE
  d = sapply(1:K, function(k) length(which(false.positive.period [1:k])) / k), # Ошибка вторго рода, считаем все TRUE
  k = 1:K
)

data.long <- melt(errors, id='k', value.name='error')
ggplot(data=data.long,
       aes(x=k, y=error, colour=variable)) +
  scale_colour_hue(labels =(c("a) Скейлограмма. Ошибка первого рода",
                              "b) Периодограмма. Ошибка первого рода",
                              "c) Скейлограмма. Ошибка второго рода",
                              "d) Периодограмма. Ошибка второго рода"))) +
  facet_wrap(~variable) +
  geom_line()
```
