# Aнализ разладки последовательности
## Введение
В данной главе мы будем оценивать положение точки разладки битовой последовательности, получая оценку как решение следующей задачи. Пусть дана последовательность бит проиндексированная в каждый момент времени $t$, то есть
  $$ x_t \in \{ 0, 1\} ~ \forall t \in \mathbb{N} $$
Предполагаем, что $\exists T$ такое, что
  $$P(x_t = 1) = 1 - P(x_t = 0) = \theta, ~ \forall t < 2^T$$
Иными словами преполагаем, что $x_t, \forall t < 2^T$ есть случанйня бернулевская величина, распределенная по закону $Be(\theta)$. Предположим также, что для __хвоста__ последовательности справедливо
  $$P(x_t = 1) = 1 - P(x_t = 0) = \gamma, ~ \forall t >= 2^T$$
то есть, величины, составляющие хвост последовательности распределены по закону $Be(\gamma)$.
Наша задача, состоит в том, чтобы оценить параметр $T$.

## Поиск разладки бинарной последовательности
Вейвлет-преобразование и статистики освнованные на вейвлет-преобразованиях помогают выявить различные закономерности или же, ноборот, отклонения от устоявшихся в данных закономерности. Такую возможность предоставляет разделение входящего сигнала на многие уровни, с различной степенью детализации.

Пусть дана последовательность такая, что первые $2^{\tau}$ бит распределены по закону Бернулли с параметром $\theta1$, а оставшиеся $2^T - 2^{\tau}$ распределены по закону Бернулли с параметром $\theta_2$, или более формально, пусть дана последовательность $X^0 = \{x_i\}_{i=\overline{1,N}}, N = 2^T$, такая что
$$
    \mathcal{L}(x_i) =
    \begin{cases}
      Be(\theta_1) = Bi(\theta_1, 1), ~ i = \overline{1,2^\tau}, \tau < T \\
      Be(\theta_2) = Bi(\theta_2, 1), ~ i = \overline{2^\tau, 2^T}
    \end{cases}
$$

,где $\theta_1, \theta_2 \in [0, 1]$, а $Be(\cdot), Bi(\cdot, \cdot)$ -- распределение Бернулли и биномиальное распределение соотвественно.
Не делая никаких предположений относительно $\theta_1$ и $\theta_2$ за исключением, разве что условия $\theta_1 \neq \theta_2$, оценим параметр $\tau$.

Для удобста работы преобразуем исходные данные. Получим новую последовательность $X$ той же длины, применяя следующее преборазование $X = 2X^0 - 1$ поэлементно к исходной последовательности $X^0$.
Пусть также задано семейство вейвлетов Хаара, определяемое следующим образом:
$$
  \psi_{jk}(t) = 2^{j/2}\psi(2^j (t - k)), ~
  \psi(t) = 
  \begin{cases}
    1, t \in [0, \frac{1}{2}[ \\
    -1, t \in [\frac{1}{2}, 1[ \\
    0, t \not\in [0, 1[
  \end{cases}
$$

Построим следующее вейвлет преобразование $d_{jk}(\cdot)$ :
$$
  d_{jk}(X) = \sum_{t=1}^T \psi(t, j, k)  x_t
$$,
что в нашем случае эквивалентно

$$
  d_{jk}(X) = 2^{-\frac{j}{2}}(\sum_{t = 2^j k}^{2^j (k + \frac{1}{2}) - 1} x_t - \sum_{t = 2^j (k+ \frac{1}{2} )}^{2^j (k + 1) - 1} x_t)
$$

Возьмем квадраты полученных коэффициентов
$$
  I_{jk}(X) = d_{jk}(X)^2
$$

и выберем максимальный из них по $k$:
$$
  I_j = \max_{k = \overline{0, m}} I_{jk}(X), ~ m = 2^{T - (j+1)}
$$

Тогда статисткиой $P_j(\cdot)$ для уровня $j$, назовем статистику вида

$$
  P_j(X) = 1 - F_{\chi^2}(I_j(X))^{T - j}
$$

, где $F_{\chi^2}$ -- функция распределения $\chi^2$

Говорим, что принимаем гипотезу $H_0$, если
$$
  P_j(X) > \varepsilon, \forall j = \overline{1,T-1}
$$
, где $\varepsilon = \frac{\varepsilon^0}{T}$,
иначе принимаем $H_1$.

### Эксперимент
```{r}
experiment <- function(T, tau, theta = 1, gamma = 0, repeats = 100){
    p.values <- function(){
      values <-2 * generator.sequence(theta, gamma, tau)(2**T) - 1
      print(mean(values))      
      p.values <- sapply(1:(T - 1), function(j) P_j(values, j))  
    }
      
    p <- rowMeans(data.frame(p.values()))
  
    plot((p), main=sprintf("T %d, Tau %d, Theta %f, Gamma %f", T, tau, theta, gamma), xlab='T' , ylab='p.values')
  }
```

```{r}
  t <- 2*sapply((0:1023), function(t) t %% 2) - 1
  p.values <- sapply(0:log(length(t))/log(2), function(j) P_j(t, j))  
  plot(p.values, xlab='j')
  t[128:256] = 0
  plot(t)
  p.values <- sapply(0:log(length(t))/log(2), function(j) P_j(t, j))  
  print(length(p.values))
  plot(p.values, xlab='j')
```



```{r}
  for(gamma in seq(0, 0.5, 0.1)) {
      experiment(14, 12, 0.5, gamma)
  }
```